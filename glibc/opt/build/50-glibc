#!/bin/bash
mkdir -p ${UBUNTU}/{pkg,rootfs} /usr/lib/x86_64-linux-gnu /lib64 /opt/app/{apache2,php71}/bin /opt/local/{apache2,php71}/log
touch ${UBUNTU}/pkg/status
cd ${UBUNTU}

# Download packages
chroot . apt install -y -d --no-install-recommends -o 'Dir::Cache::Archives=/pkg' -o 'Dir::State::status=/pkg/status' libc-bin
chroot . bash -c 'for f in pkg/*.deb; do dpkg -x $f rootfs/; done'

# libs
cd ${UBUNTU}/rootfs
cp -a usr/lib/l*.so* $(find lib/x86_64-linux-gnu usr/lib/x86_64-linux-gnu -name 'l*.so*') /usr/lib/x86_64-linux-gnu/
cp usr/share/libc-bin/nsswitch.conf /etc/
tar cf - etc/ld.* {sbin,usr/bin}/ld* usr/lib/locale/C.UTF-8 | ( cd / && tar xvf - )
ln -sf /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2 /lib64/
ldconfig
